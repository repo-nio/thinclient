<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
    	<title>Nixxis Live Chat</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <script type="text/javascript" src="chatLink.js"></script>
        <link rel="stylesheet" type="text/css" href="nixxischat.css">
        
        <script type="text/javascript">
		    //var chatSession = new chatLink('/*[conversationid]*/','/*[sessionid]*/');
			var convid = '/*[conversationid]*/';
			var session = '/*[sessionid]*/';
			var contextId = '';
			var internalId = '';

			if(session.substring(0, 2) == '/*')
        	{
            	session = ''; 
            }
            
			var chatSession = null;
			if(session)
        	{
        		chatSession = new chatLink('/*[conversationid]*/','/*[sessionid]*/');
            }
            
	        function onLoad()
	        {
	        	if(session)
	        	{
	        		//chatSession = new chatLink('/*[conversationid]*/','/*[sessionid]*/');
		            chatSession.waitEvent.Add(OnWait);
		            chatSession.activateEvent.Add(OnActivate);
		            chatSession.historyLineEvent.Add(OnHistoryLine);
		            chatSession.disconnectEvent.Add(OnDisconnectChat);
		            
		            var request;
					var response = "";
					try 
					{
						request = new XMLHttpRequest();
						request.open('GET', "http://" + window.location.host + "/data?action=createContextData&contact=" + convid, false);
						request.send();
						response = request.responseText;
						contextId = response.substr(response.indexOf("context=", 0) + "context=".length + 1, 32);
						internalId = response.substr(response.indexOf("internalId=", 0) + "internalId=".length + 1, 32);
					}
					catch(e) {}
	            }
	        }
	        
	        function onUnload()
	        {	    
	       		if(chatSession)
	        	{
	            	chatSession.disconnect();
				}
	        }
	        
	        function on_connect()
	        {
	        	if(!chatSession)
	        	{
	        		document.forms["login"].submit();
	        	}
	        }
	        
	        function on_disconnect()
	        {	       		
	        	if(chatSession)
	        	{
	        		chatSession.disconnect();
	        	}
	        }
	        
	        function on_send()
	        {
	        		chatSession.send(document.getElementById('message').value);
	        		document.getElementById('message').value = "";
	        }
	        
		    function message_onkeypress(e)
		    {	        
		        var evt = e ? e : window.event;
			    
			    if (evt.keyCode == 13)
			    { 
			        on_send();
			        evt.returnValue = false;
		            evt.cancel = true;
		            return false;
			    }
		    }
		    function message_onfocus()
		    {
		    	try
		    	{
			    	if(!document.getElementById('message').initMsgDeleted)
			    	{
			    		document.getElementById('message').value = '';
			    		document.getElementById('message').initMsgDeleted = true;
			    	}
		    	}catch(e)
		    	{
		    		document.getElementById('message').value = '';
			    	document.getElementById('message').initMsgDeleted = true;
		    	}
		    }
		    function OnDisconnectChat()
		    {
		    	window.open("http://" + window.location.host + window.location.pathname + "nixxischatenq.html?context=" + contextId + "&internalid=" + internalId + "&lang=en",'Title','width=580,height=650,scrollbars=yes,resizable=yes');
		    }
		    
	        function OnWait()
	        {
	            document.getElementById('transcript').innerHTML = arguments[0];
	
	            //document.getElementById('chatWait').style.display = "inline";
	            //document.getElementById('chatActive').style.display = "none";
	        }
	        
	        function OnActivate()
	        {
				////debugger;
				document.getElementById('transcript').innerHTML = "";
	        }
	
	        function OnHistoryLine(historyInfo) 
	        {
				////debugger;
	            var ownerDiv = document.getElementById('transcript');	            
	         
	            if(historyInfo.historyType == chatSession.chatEventType.Say)
	            {
	                var childP = document.createElement('P');
	
	                if(historyInfo.fromMySelf)
	                    childP.innerHTML = '<B>' + historyInfo.from + ':</B> ' + historyInfo.text;
	                else if(historyInfo.fromAgent)
	                    childP.innerHTML = '<B>' + historyInfo.from + ':</B> ' + historyInfo.text;
	                else
	                    childP.innerHTML = historyInfo.from + ': ' + historyInfo.text;
	                    
	                ownerDiv.appendChild(childP);
	            }
	            else if (historyInfo.historyType == chatSession.chatEventType.Leave)
	            {
	                var childP = document.createElement('P');
	            
	                childP.innerHTML = '<B><I>' + historyInfo.text + '</I></B>';
	                ownerDiv.appendChild(childP);
	            }
	            else
	            {
	                var childP = document.createElement('P');
	            
	                childP.innerHTML = '<B><I>' + historyInfo.text + '</I></B>';
	                ownerDiv.appendChild(childP);
	            }
	            
	            ownerDiv.scrollTop = ownerDiv.scrollHeight;
	        }
	    </script>
    </head>
    <body onload="javascript:onLoad();" onunload="javascript:onUnload();">
		<table class="window" cellspacing="0" cellpadding="0">
			<tbody>
				<tr class="title">
					<td><h2><a>Nixxis</a> Chat</h2></td>
				</tr>
				<tr class="welcome">
					<td> This service is reserved for customers. If you are not an customer, please contact us using another of our channels. At the end of your chat session please complete our short survey. </td>
				</tr>
				<tr class="info">
					<td>
						<table class="header" width="100%" cellspacing="0" cellpadding="0">
							<tbody>
								<tr>
									<td> Please enter your personal information </td>
								</tr>
							</tbody>
						</table>
						<form id="login" name="login" method="get" enctype="application/x-www-form-urlencoded" accept-charset="utf-8">
							<input type="hidden" name="action" value="begin" />
							<table class="data" width="100%" cellspacing="0" cellpadding="0">
								<tbody>
									<tr class="emailaddress">
										<td width="38%"><span id="EmailAddressLabel">E-mail address:</span></td>
										<td class="input"><input id="EmailAddress" type="text" name="nickName"></td>
									</tr>
								</tbody>
							</table>
						</form>	
					</td>
				</tr>
				<tr class="top">
					<td> </td>
				</tr>
				<tr class="panel">
					<td align="center">
						<a id="StartChatHyperLink" class="start" href="javascript:on_connect();">
							<span>Start chat</span>
						</a>
						<a id="StopChatHyperLink" class="stop" href="javascript:on_disconnect();">
							<span>Stop chat</span>
						</a>
					</td>
				</tr>
				<tr class="transcript">
	                <td>
	                    <div name="transcript" rows="2" cols="20" id="transcript" class="transcriptbox">Need help online? Chat live with our experts who will answer your questions, from Monday to Friday between 8 am and 8 pm.</div>
	                </td>					
				</tr>
				<tr class="message">
	                <td>
	                    <textarea name="message" rows="2" cols="20" id="message" class="messagebox" onfocus="javascript: message_onfocus();" onkeypress="javascript:message_onkeypress(event);">Enter your message here.</textarea>
	                </td>					
				</tr>
				<tr class="footer">
	                <td>
	                    <a id="send" class="send" href="javascript:on_send();"><span>Send</span></a>
	                </td>					
				</tr>
				<tr class="bottom">
					<td> </td>
				</tr>
			</tbody>
		</table>
    </body>
</html>
